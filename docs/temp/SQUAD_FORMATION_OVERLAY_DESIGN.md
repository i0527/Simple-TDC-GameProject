# Cat Tower Defense - 編成オーバーレイUI設計

**最終更新**: 2026-01-08  
**対象**: SquadFormationOverlay UIレイアウト・設計  
**ステータス**: 設計完了・詳細実装はCursorで実施  

---

## 📋 目次

1. [概要](#概要)
2. [デザイン原則](#デザイン原則)
3. [UIレイアウト](#uilayout)
4. [機能仕様](#機能仕様)
5. [画面座標・寸法](#画面座標寸法)
6. [インタラクション仕様](#インタラクション仕様)
7. [色・フォント・サイズ](#色フォントサイズ)
8. [実装データ構造](#実装データ構造)

---

## 概要

### 🎯 設計ビジョン

**10キャラクター編成**に対応した、**FHD (1920x1080) 画面に最適化された編成オーバーレイ**です。  
参考画像の魔法カード編成システムをベースに、タワーディフェンス用にカスタマイズしています。

✅ **効率的なレイアウト**: 編成中(上) vs 編成可能(下) の明確な分離  
✅ **ドラッグ&ドロップ対応**: カード移動による直感的な編成  
✅ **コスト管理UI**: 合計コスト表示・リアルタイム計算  
✅ **スクロール対応**: キャラクター数が多い場合に対応  
✅ **視認性重視**: 暗めの背景に明るいUIで対比  
✅ **スマートなスペース使用**: オーバーレイ内に効率的に配置  

### 主要ターゲット

- **画面サイズ**: 1920x1080 (FHD)
- **編成数**: 10キャラクター固定
- **編成スロット**: 10個
- **コスト制限**: 合計コストに上限あり (オーバーレイで管理)

---

## デザイン原則

### 1. **構造の明確性**

```
上部: 編成中の隊列表示
    ↓ (視覚的分離線)
中央: コスト情報・統計情報
    ↓ (視覚的分離線)
下部: 編成可能なキャラクター一覧
```

### 2. **優先度の視覚化**

- **編成中**: 大きく、目立つ位置に配置
- **コスト**: わかりやすく中央に表示
- **編成可能**: スクロール可能、小さめサイズ

### 3. **直感的な操作**

- **ドラッグ&ドロップ**: カードを移動
- **ワンクリック追加**: 素早い編成
- **即座の反応**: コスト変動がリアルタイムで表示

### 4. **FHDスクリーンの最適活用**

- **水平スペース**: 1920pxを有効活用
- **垂直スペース**: 1080pxを効率的に分割
- **パディング**: 適切な余白でリッチ感を演出

---

## UILayout

### 全体構成

```
┌────────────────────────────────────────────────────────────────────────────────┐
│ 【編成画面】                                                   [  ✕ 閉じる ]  │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                │
│  編成隊列 (10スロット: 5列x2行)                                              │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │ [キャラ] [キャラ] [キャラ] [キャラ] [キャラ]                              │  │
│  │ [キャラ] [キャラ] [キャラ] [キャラ] [キャラ]                              │  │
│  │ [empty]  [empty]  [empty]  [empty]  [empty]                              │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                │
│  コスト情報パネル  【合計: 45 / 100】  【キャラ数: 5 / 10】                    │
│                                                                                │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                │
│  編成可能キャラクター (スクロール対応)                                        │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │ [キャラ]  [キャラ]  [キャラ]  [キャラ]  [キャラ]  ...    [スクロール]     │  │
│  │ [キャラ]  [キャラ]  [キャラ]  [キャラ]  [キャラ]  ...                     │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
│                          【完成】  【キャンセル】                              │
│                                                                                │
└────────────────────────────────────────────────────────────────────────────────┘
```

### 詳細レイアウト

#### 上部: 編成隊列エリア

```
位置: (160, 80) - (1760, 300)
高さ: 220px

構成: 10スロット (5列x2行)
スロットサイズ: 100x100px (カード)
スロット間隔: 20px
スロット背景: 暗グレー / ホバー時: 明るいグレー / 選択時: ゴールド枠

レイアウト:
行1: slot[0]  slot[1]  slot[2]  slot[3]  slot[4]
行2: slot[5]  slot[6]  slot[7]  slot[8]  slot[9]

パディング:
  左: 60px
  右: 60px
  上: 30px
  下: 20px
```

#### 中央: コスト情報パネル

```
位置: (160, 310) - (1760, 380)
高さ: 70px

背景: グラデーション (濃い灰色)
ボーダー: ゴールド (2px)

表示項目:
- 左側: 合計コスト表示
  ┌─────────────────────┐
  │ 【合計コスト】      │
  │ 45 / 100 MP         │
  └─────────────────────┘

- 中央: キャラクター数
  ┌─────────────────────┐
  │ 【編成数】          │
  │ 5 / 10              │
  └─────────────────────┘

- 右側: 編成可能表示 / 警告
  ┌─────────────────────┐
  │ 【編成可能】 ✓      │
  │ または               │
  │ 【コスト超過】 ✗    │
  └─────────────────────┘

フォント: 24px (ラベル), 32px (値)
色: ゴールド/白 / 警告時: 赤
```

#### 下部: 編成可能キャラクター一覧

```
位置: (160, 390) - (1760, 750)
高さ: 360px

背景: 暗グレー (スクロール対応)

表示形式: グリッド (7列x3行表示)
カードサイズ: 80x100px
間隔: 15px

表示内容:
- キャラクターアイコン (上)
- キャラクター名 (中)
- コスト表示 (下)

スクロール機能:
- マウスホイール対応
- スクロールバー表示
- スナップ機能

ステータス:
- 未発見: グレーアウト
- 所持: 通常表示
- 編成済み: 薄く表示 (重複警告)
```

#### 下部ボタン

```
位置: (160, 770) - (1760, 820)
高さ: 50px

ボタン配置:
┌─────────┐                      ┌──────────┐ ┌──────────┐
│ 【完成】 │ ============ 空白 ========== │キャンセル│ │  リセット  │
└─────────┘                      └──────────┘ └──────────┘
  x=540           (中央)          x=1040      x=1380

ボタンサイズ: 120x50px (完成/キャンセル), 100x50px (リセット)
```

---

## 機能仕様

### 1. **編成スロット管理**

#### スロット状態

```
[Empty]
  ├─ アイコン: ロック記号またはプラスアイコン
  ├─ クリック: キャラクター選択画面へ遷移
  ├─ ドラッグ: なし
  └─ ホバー: 薄いハイライト

[Assigned Character]
  ├─ アイコン: キャラクターアイコン
  ├─ 名前: キャラクター名表示
  ├─ コスト: コスト表示
  ├─ クリック: 詳細表示
  ├─ ドラッグ: スロット間で移動可能
  ├─ 右クリック: 削除メニュー
  └─ ホバー: キャラクター詳細ツールチップ表示
```

#### スロットレイアウト (単一カード 100x100)

```
┌─────────────────┐
│   [Icon Area]   │  (80x60)
│   キャラクター  │
├─────────────────┤
│ キャラ名        │  (14px)
│ Lv3 Cost:5      │  (12px)
└─────────────────┘
```

### 2. **コスト管理**

#### リアルタイムコスト計算

```cpp
total_cost = sum(all_assigned_characters.cost)
available_cost = max_cost - total_cost

状態:
- available_cost > 0: 【編成可能】 (緑)
- available_cost == 0: 【コスト満杯】 (黄)
- available_cost < 0: 【コスト超過】 (赤) ← 非許可状態
```

#### コスト表示

- **合計コスト**: `45 / 100 MP`
- **残りコスト**: `55 MP (残り)`
- **警告**: コスト超過時は赤背景で表示

### 3. **ドラッグ&ドロップ**

```
操作フロー:
1. ユーザーがカードを長押しまたはドラッグ開始
2. カードが半透明・浮上効果に
3. マウス移動に追従
4. スロット上でドロップ
   ├─ スロット空: キャラクター配置
   ├─ スロット埋: 要素交換 (Swap)
   └─ エリア外: キャンセル

フィードバック:
- ドラッグ中: 透明度 70%
- ドロップ可能エリア: ハイライト
- ドロップ確定: 短いアニメーション
```

### 4. **キャラクター一覧フィルタリング**

```
表示対象:
- ✓ 発見済みキャラクター
- ✓ 未編成キャラクター (同一キャラの重複配置不可)
- ✓ 編成中キャラ (薄表示・クリック不可)
- ✗ 未発見キャラクター (グレーアウト・クリック不可)

並べ替え:
1. レアリティ降順 (SSR → SR → R → N)
2. レベル降順
3. コスト昇順
4. 名前順 (50音順)
```

### 5. **検証・確認**

#### 編成完了時の検証

```
【完成】ボタンクリック時:

1. コスト確認
   ✓ available_cost >= 0 → OK
   ✗ available_cost < 0 → エラーダイアログ

2. 編成数確認
   ✓ 1 <= count <= 10 → OK
   ✗ count == 0 → 警告: 「1体以上編成してください」

3. 確認ダイアログ
   「編成を確定しますか？」
   ├─ OK: 編成保存 → ゲーム画面へ戻る
   └─ Cancel: 編成画面に戻る
```

---

## 画面座標・寸法

### 全体フレーム (オーバーレイ)

```
┌─ 全体 ─────────────────────────────────┐
│  x: 160  y: 60  w: 1600  h: 800        │
│ (オーバーレイの全体範囲)                 │
└───────────────────────────────────────┘
```

### 各パネルの座標

| パネル | X | Y | W | H | 説明 |
|--------|---|---|---|---|------|
| **タイトルバー** | 160 | 60 | 1600 | 50 | 「編成画面」タイトル + 閉じる |
| **編成隊列** | 160 | 115 | 1600 | 180 | 10スロット表示 |
| **区切り線** | 160 | 295 | 1600 | 2 | ビジュアル分離 |
| **コスト情報** | 160 | 310 | 1600 | 70 | 合計コスト・編成数表示 |
| **区切り線** | 160 | 385 | 1600 | 2 | ビジュアル分離 |
| **キャラ一覧** | 160 | 390 | 1600 | 360 | スクロール可能なキャラリスト |
| **ボタン群** | 160 | 770 | 1600 | 50 | 完成・キャンセル・リセット |

### スロット配置 (編成隊列内)

```
スロット番号と座標:

行1: 
  Slot[0] (200, 135)    Slot[1] (360, 135)    Slot[2] (520, 135)    Slot[3] (680, 135)    Slot[4] (840, 135)
  
行2:
  Slot[5] (200, 245)    Slot[6] (360, 245)    Slot[7] (520, 245)    Slot[8] (680, 245)    Slot[9] (840, 245)

スロットサイズ: 100x100
スロット間隔: 60px (中心間隔)
左パディング: 40px (160 + 40)
```

---

## インタラクション仕様

### マウス操作

#### 1. 編成スロット上の操作

```
【左クリック】
- Empty スロット: キャラクター選択ダイアログ (or ドロップ受け入れ)
- Assigned スロット: キャラクター詳細表示

【長押し / ドラッグ】
- Assigned スロット: ドラッグ開始
  ├─ ドラッグ中: 透明度低下・追従
  └─ ドロップ: スロット交換

【右クリック】
- Assigned スロット: コンテキストメニュー
  ├─ 削除
  ├─ 詳細表示
  └─ キャンセル

【ホバー】
- All スロット: ツールチップ表示 (キャラ情報)
```

#### 2. キャラクター一覧上の操作

```
【左クリック】
- キャラクターカード: 編成スロットへドロップ可能な状態に移行

【ドラッグ】
- キャラクターカード: 直接スロットへドラッグ&ドロップ

【ホバー】
- キャラクターカード: ツールチップ表示
```

#### 3. ボタン操作

```
【完成ボタン】
- クリック: 編成確認ダイアログ表示

【キャンセルボタン】
- クリック: 編成前の状態に戻す確認 → 編成画面終了

【リセットボタン】
- クリック: 編成をリセット確認 → 全スロットをクリア
```

### キーボード操作

```
【Esc キー】
- キャンセルと同等 (編成画面終了)

【Delete / Backspace】
- 選択中のスロット内容を削除
```

---

## 色・フォント・サイズ

### 色パレット

#### 背景色

```cpp
Color overlay_bg = {20, 25, 30, 240};        // 半透明暗グレー (メイン背景)
Color panel_bg = {40, 45, 50, 255};          // パネル背景
Color panel_accent = {60, 70, 80, 255};      // パネルアクセント
Color slot_empty = {50, 50, 55, 255};        // 空スロット背景
Color slot_hover = {70, 75, 85, 255};        // ホバー時背景
Color slot_selected = {200, 170, 100, 255};  // 選択時背景 (ゴールド)
```

#### テキスト色

```cpp
Color text_primary = {255, 255, 255, 255};   // 白 (主要テキスト)
Color text_secondary = {180, 180, 180, 255}; // グレー (補助テキスト)
Color text_accent = {240, 170, 60, 255};     // ゴールド (強調)
Color text_error = {255, 80, 80, 255};       // 赤 (エラー)
Color text_success = {100, 200, 100, 255};   // 緑 (成功)
```

#### ボタン色

```cpp
Color btn_primary = {240, 170, 60, 255};     // ゴールド (完成ボタン)
Color btn_primary_hover = {255, 190, 80, 255};
Color btn_primary_active = {200, 140, 40, 255};

Color btn_secondary = {80, 90, 100, 255};    // グレー (キャンセルボタン)
Color btn_secondary_hover = {100, 110, 120, 255};

Color btn_reset = {100, 100, 110, 255};      // 薄グレー (リセットボタン)
Color btn_reset_hover = {120, 120, 130, 255};
```

### フォント・サイズ

```cpp
// タイトルバー
const int FONT_TITLE = 28;           // 「編成画面」

// 編成スロット内
const int FONT_SLOT_NAME = 14;       // キャラクター名
const int FONT_SLOT_INFO = 12;       // Lv/Cost

// コスト情報パネル
const int FONT_COST_LABEL = 20;      // 【合計コスト】
const int FONT_COST_VALUE = 36;      // 45 / 100

// キャラクター一覧
const int FONT_CARD_NAME = 13;       // キャラクター名
const int FONT_CARD_INFO = 11;       // Cost/Lv

// ボタン
const int FONT_BUTTON = 18;          // ボタンテキスト

// ツールチップ
const int FONT_TOOLTIP = 12;         // ツールチップテキスト
```

### パディング・マージン

```cpp
// 内側余白
const int PADDING_LARGE = 40;        // パネル間
const int PADDING_MEDIUM = 20;       // 要素間
const int PADDING_SMALL = 10;        // テキスト周囲

// 外側余白
const int MARGIN_OVERLAY = 160;      // オーバーレイ外側
const int MARGIN_PANEL = 20;         // パネル内側
```

---

## 実装データ構造

### SquadFormationOverlay 構造

```cpp
class SquadFormationOverlay : public IOverlay {
public:
    struct SquadSlot {
        int slot_id;                 // 0-9
        Character* assigned_character; // nullptr = empty
        int position_x, position_y;   // 画面座標
        int width = 100, height = 100;
        bool is_hovered = false;
        bool is_dragging = false;
    };
    
    struct CostPanel {
        int total_cost = 0;
        int max_cost = 100;
        int character_count = 0;
        int max_character_count = 10;
        
        bool IsCostValid() const {
            return total_cost <= max_cost;
        }
        
        bool IsComplete() const {
            return character_count > 0 && IsCostValid();
        }
    };
    
    struct CharacterListView {
        std::vector<Character*> available_characters;
        int scroll_offset = 0;
        int visible_columns = 7;
        int visible_rows = 3;
        int selected_character_index = -1;
        
        const int CARD_WIDTH = 80;
        const int CARD_HEIGHT = 100;
    };
    
    // ========== メンバー変数 ==========
    SquadSlot squad_slots[10];
    CostPanel cost_panel;
    CharacterListView character_list;
    
    Character* dragging_character = nullptr;
    int dragging_source_slot = -1;
    
    // ========== メソッド ==========
    void AssignCharacter(int slot_id, Character* character);
    void RemoveCharacter(int slot_id);
    void SwapCharacters(int slot1_id, int slot2_id);
    
    void UpdateCostPanel();
    void ValidateSquadComposition();
    
    void OnSlotClicked(int slot_id);
    void OnCharacterDragged(Character* ch);
    void OnCharacterDropped(int target_slot_id);
    
    void FilterAvailableCharacters();
    void ScrollCharacterList(int direction);
};
```

### UI座標計算ヘルパー

```cpp
// スロット座標計算
struct SquadLayoutCalculator {
    static const int SLOT_WIDTH = 100;
    static const int SLOT_HEIGHT = 100;
    static const int SLOT_SPACING = 60;
    static const int START_X = 200;
    static const int START_Y = 135;
    
    static Vector2 GetSlotPosition(int slot_id) {
        // slot_id = 0-4: 行1, 5-9: 行2
        int row = slot_id / 5;
        int col = slot_id % 5;
        return {
            START_X + col * SLOT_SPACING,
            START_Y + row * SLOT_SPACING
        };
    }
};

// キャラクター一覧座標計算
struct CharacterCardLayoutCalculator {
    static const int CARD_WIDTH = 80;
    static const int CARD_HEIGHT = 100;
    static const int CARD_SPACING_X = 95;
    static const int CARD_SPACING_Y = 125;
    static const int START_X = 180;
    static const int START_Y = 410;
    static const int COLUMNS = 7;
    
    static Vector2 GetCardPosition(int card_index) {
        int row = card_index / COLUMNS;
        int col = card_index % COLUMNS;
        return {
            START_X + col * CARD_SPACING_X,
            START_Y + row * CARD_SPACING_Y
        };
    }
};
```

---

## ワークフロー

### 編成フロー

```
1. 編成画面開く
   ↓ SquadFormationOverlay Initialize
   
2. 既存編成データ読込 (あれば)
   ↓ LoadSquadData()
   
3. 利用可能キャラクター一覧生成
   ↓ FilterAvailableCharacters()
   
4. UI描画
   ┌─ 編成スロット描画
   ├─ コスト情報描画
   ├─ キャラクター一覧描画
   └─ ボタン描画
   
5. ユーザー操作受付
   ├─ ドラッグ&ドロップ
   ├─ スクロール
   ├─ ボタンクリック
   └─ リアルタイムコスト更新
   
6. 【完成】クリック
   ↓ ValidateSquadComposition()
   ├─ OK: 確認ダイアログ → 保存 → 画面終了
   └─ NG: エラーダイアログ → 編成画面に戻る
```

### キャラクター追加フロー

```
1. 空スロットまたはキャラクターカードをクリック
   ↓
2. 対象キャラクター選定
   ├─ スロットの場合: キャラクター一覧から選択
   └─ カードの場合: 直接追加
   ↓
3. AssignCharacter(slot_id, character)
   ├─ 検証: コスト確認
   ├─ スロット割り当て
   └─ UI更新
   ↓
4. UpdateCostPanel()
   ├─ 合計コスト再計算
   ├─ UI反映
   └─ 警告表示 (必要時)
```

---

## 使いやすさ考慮点

### アクセシビリティ

- ✅ **キーボード操作対応**: Tabキーでフォーカス移動、Enterで確定
- ✅ **ツールチップ**: すべてのUI要素にホバーで説明表示
- ✅ **色覚異常対応**: 赤/緑以外の要素で状態判定可能 (記号 + テキスト)
- ✅ **高コントラスト**: 背景と前景の色差で視認性確保

### パフォーマンス

- ✅ **仮想スクロール**: キャラクター一覧を効率的に描画
- ✅ **遅延計算**: コスト計算は必要時のみ
- ✅ **テクスチャキャッシュ**: キャラクターアイコンを事前キャッシュ

### UX

- ✅ **即座フィードバック**: すべての操作に視覚的反応
- ✅ **Undo/Reset**: 【リセット】ボタンで簡単にリセット可能
- ✅ **確認ダイアログ**: 重要な操作は確認を要求
- ✅ **ツールチップ**: わからない時は長押しで説明表示

---

## 実装順序 (Cursor推奨)

### Phase 1: UI基本フレーム
1. SquadFormationOverlay クラス作成
2. パネルの背景・枠線描画
3. タイトルバー実装

### Phase 2: スロット・コスト
4. 10個スロットレイアウト実装
5. コスト情報パネル実装
6. リアルタイムコスト計算

### Phase 3: キャラクター一覧
7. キャラクター一覧グリッド実装
8. スクロール機能実装
9. フィルタリング実装

### Phase 4: インタラクション
10. ドラッグ&ドロップ実装
11. ボタン・コンテキストメニュー実装
12. 検証・確認ダイアログ

### Phase 5: ポーランド・最適化
13. アニメーション・エフェクト
14. パフォーマンス最適化
15. テスト・バグ修正

---

## まとめ

### 🎯 設計ハイライト

| 要素 | 特徴 |
|------|------|
| **レイアウト** | 3層構造 (編成中/コスト/編成可能) で直感的 |
| **操作性** | ドラッグ&ドロップで効率的な編成 |
| **視認性** | FHD画面に最適化、暗いテーマで目に優しい |
| **スケーラビリティ** | 10キャラ対応、将来の拡張も容易 |
| **検証** | コスト管理・編成数確認で安全な編成 |

### ✅ チェックリスト (実装時参考)

- [ ] 編成スロット: 10個、5列x2行レイアウト
- [ ] コスト管理: 合計表示・即座更新
- [ ] キャラクター一覧: グリッド・スクロール対応
- [ ] ドラッグ&ドロップ: スムーズな操作感
- [ ] 検証・警告: 超過・未編成の場合に表示
- [ ] ボタン: 完成・キャンセル・リセット

---

**編成オーバーレイ設計完了！** 🎮  
Cursor での実装に進んでください。
