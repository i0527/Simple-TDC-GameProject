# TDゲーム ゲームデザイン仕様書

**プロジェクト**: SimpleTDCGame_NewArch  
**バージョン**: 0.1.0（ドラフト）  
**最終更新**: 2025-12-08

---

## 📑 目次

1. [ゲーム概要](#ゲーム概要)
2. [画面フロー](#画面フロー)
3. [ゲーム内メイン画面（ホーム）](#ゲーム内メイン画面ホーム)
4. [TD ゲーム内の状態遷移](#tdゲーム内の状態遷移)
5. [セーブ・ロード仕様](#セーブロード仕様)
6. [データ永続化](#データ永続化)

---

## ゲーム概要

### 基本情報
- **ゲームタイプ**: 横スクロール タワーディフェンス（TD）
- **ゲームスタイル**: にゃんこ大戦争風
- **対象プラットフォーム**: Windows
- **セーブシステム**: ローカル JSON ファイルベース

### ゲーム進行構造
```
タイトル → ホーム（メインハブ）→ ステージ選択 → TD ゲーム → リザルト → ホーム
```

---

## 画面フロー

### タイトル画面

```
┌─ タイトル画面 ─────────────────────┐
│                                    │
│  ▶ 続きから（セーブデータ選択）    │
│  ▶ 新規ゲーム                      │
│  ▶ 設定                            │
│  ▶ 終了                            │
│                                    │
└────────────────────────────────────┘
```

#### フロー詳細

| 選択肢 | 遷移先 | 処理内容 |
|--------|--------|---------|
| **続きから** | セーブデータ選択画面 | 1. 保存されているセーブファイルの一覧表示（スロット1～3または複数） 2. 選択したデータをロード 3. ホーム画面へ遷移 |
| **新規ゲーム** | チュートリアル（初回のみ）/ ホーム | 1. 新規セーブデータを生成 2. 初回フラグ確認 3. チュートリアル表示 → ホーム へ遷移 |
| **設定** | 設定画面 | マスターボリューム、BGM/SE、言語、グラフィック設定など |
| **終了** | プロセス終了 | アプリケーション終了 |

#### 初回フラグと永続化
- **初回フラグ**: `player.first_play` (boolean)
  - `true` → チュートリアル強制表示
  - `false` → スキップ
  - チュートリアル完了時に `false` に更新してセーブ

---

### ホーム画面（メインハブ）

```
┌─ ホーム ───────────────────────────────────┐
│                                            │
│  [ユーザー情報]  [通貨表示]  [設定] [終了]│
│                                            │
│  ┌─ ゲーム機能 ─────────────────────────┐ │
│  │                                      │ │
│  │  ▶ ステージ選択 → TD ゲーム開始      │ │
│  │                                      │ │
│  │  ▶ 編成                              │ │
│  │     ├─ デッキ編集                    │ │
│  │     └─ アビリティセット              │ │
│  │                                      │ │
│  │  ▶ キャラ強化                        │ │
│  │     ├─ レベルアップ                  │ │
│  │     ├─ スキル強化                    │ │
│  │     └─ 進化                          │ │
│  │                                      │ │
│  │  ▶ 図鑑                              │ │
│  │     ├─ キャラ図鑑                    │ │
│  │     ├─ 敵図鑑                        │ │
│  │     └─ 実績                          │ │
│  │                                      │ │
│  │  ▶ プレイヤー情報                    │ │
│  │     ├─ ユーザーランク                │ │
│  │     ├─ 所持通貨                      │ │
│  │     └─ 称号                          │ │
│  │                                      │ │
│  │  ▶ ガチャ（後回し可）                │ │
│  │                                      │ │
│  │  ▶ サブゲーム（後回し可）            │ │
│  │                                      │ │
│  └──────────────────────────────────────┘ │
│                                            │
└────────────────────────────────────────────┘
```

#### ホーム機能一覧

| メニュー項目 | 詳細 | 優先度 |
|------------|------|--------|
| **ステージ選択** | ステージリスト表示 → 詳細パネル → 編成確認 → TD ゲーム開始 | 🔴 必須 |
| **編成** | デッキ管理、アビリティセット変更 | 🔴 必須 |
| **キャラ強化** | レベルアップ、スキル強化、進化 | 🟠 重要 |
| **図鑑** | キャラクター図鑑、敵図鑑、実績 | 🟡 中程度 |
| **プレイヤー情報** | ランク、通貨、称号表示 | 🟡 中程度 |
| **ガチャ** | ランダムキャラ取得（ゲーム内通貨使用） | 🟢 後回し可 |
| **サブゲーム** | ボーナスステージ等（未定） | 🟢 後回し可 |

---

## ゲーム内メイン画面（ホーム）

### ステージ選択フロー

```
ステージ選択
  ↓
ステージ詳細パネル表示
  ├─ ステージ名
  ├─ 難易度
  ├─ 推奨ユーザーランク
  ├─ クリア条件
  ├─ 敵の構成情報
  └─ 開始ボタン / キャンセルボタン
  ↓
編成確認パネル
  ├─ メイン編成（3枠 + 出撃制限）
  ├─ アビリティセット（2枠）
  ├─ サブキャラ（5枠 - 無制限召喚）
  └─ 開始 / 編成変更 / キャンセル
  ↓
TD ゲーム開始
```

### 編成パネル詳細

#### 編成構成（全10枠）

```yaml
編成構成:
  メイン編成:
    - 枠数: 3
    - 特徴: 
        - 高スペック（攻撃力・HP・スキル効果が高い）
        - 出撃制限あり（連続出撃に制限、クールタイム存在）
        - レアリティが高い傾向
    - スロット例:
        - メイン1: ボスキラー系ユニット
        - メイン2: 殲滅力重視ユニット
        - メイン3: サポート・範囲攻撃ユニット

  アビリティセット:
    - 枠数: 2
    - 特徴:
        - スキル型（使用時に任意発動）
        - グローバルバフ・デバフ効果
        - 一定時間有効または1回限りの効果
    - スロット例:
        - スキル1: 味方全体攻撃力UP（20秒）
        - スキル2: 敵グループを一時停止

  サブキャラ:
    - 枠数: 5
    - 特徴:
        - にゃんこ大戦争の「ねこ」に相当
        - 無制限召喚可能
        - ローコスト・短いクールタイム
        - 消耗品的な戦術運用
    - スロット例:
        - サブ1: 近距離攻撃ユニット（量産型）
        - サブ2: 遠距離攻撃ユニット
        - サブ3: タンク型
        - サブ4: バフ提供ユニット
        - サブ5: 予備スロット
```

---

## TD ゲーム内の状態遷移

### ゲーム状態図

```
Loading → Ready（カウントダウン） → Playing ↔ Paused → Victory / Defeat → Result
```

### 各状態の詳細

#### 1. Loading（ロード状態）

```yaml
Loading:
  処理内容:
    - ステージデータのロード
    - キャラクターパラメータの読み込み
    - スキル・エフェクトデータの初期化
    - 敵配置パターンの準備
  画面表示:
    - ロード進捗バー（オプション）
    - "Loading..." テキスト
  遷移先: Ready（ロード完了時）
```

#### 2. Ready（準備状態・カウントダウン）

```yaml
Ready:
  処理内容:
    - ゲーム開始前のカウントダウン（3秒程度）
    - プレイヤーが編成を最終確認
    - 敵の出現準備
  画面表示:
    - ステージ背景
    - 自分の編成表示
    - 敵の第1ウェーブ情報
    - カウントダウン数字（3 → 2 → 1 → Go!）
  遷移先: Playing（カウントダウン完了時）
```

#### 3. Playing（ゲーム進行中）

```yaml
Playing:
  処理内容:
    - 敵の出現・移動・攻撃
    - プレイヤーユニットの召喚・移動・攻撃
    - スキル発動
    - HP/CP（コスト）の管理
    - クリア条件 / 敗北条件の判定
  入力操作:
    - タッチ / マウスクリック: ユニット召喚
    - スキルボタン押下: スキル発動
    - Pause キー（Esc / P キー等）: Paused へ遷移
  画面表示:
    - ゲームフィールド（1ライン横スクロール）
    - プレイヤーHP / 敵HP（ボスの場合）
    - CP（コスト）ゲージ & 再生速度表示
    - スキルクールタイム表示
    - ウェーブ情報 / 進捗表示
    - 経過時間表示
  遷移先: 
    - Paused（一時停止要求時）
    - Victory（クリア条件達成時）
    - Defeat（敗北条件達成時）
```

#### 4. Paused（一時停止中）

```yaml
Paused:
  処理内容:
    - ゲームロジック一時停止
    - メニュー表示
  画面表示:
    - ゲーム画面（半透明暗転オーバーレイ）
    - ポーズメニュー:
        ├─ 再開 (Playing へ)
        ├─ 設定（マスターボリュームなど）
        ├─ リトライ（ステージリセット → Ready へ）
        └─ 戦闘終了（ホームへ）
  遷移先:
    - Playing（再開ボタン）
    - 設定画面（設定ボタン）
    - Ready（リトライボタン）
    - ホーム（戦闘終了ボタン）
```

#### 5. Victory（勝利状態）

```yaml
Victory:
  条件:
    - 全敵を撃破（敵 HP = 0）
    - 敵がプレイヤーベースに到達しない
  画面表示:
    - "VICTORY!" テキスト
    - 獲得報酬サマリー（ゴールド、経験値、アイテム等）
    - 自動的にリザルト画面へ遷移（2～3秒）
  遷移先: Result（リザルト画面）
```

#### 6. Defeat（敗北状態）

```yaml
Defeat:
  条件:
    - プレイヤー HP = 0
    - 敵がプレイヤーベースに到達
    - 制限時間超過（ステージにより異なる）
  画面表示:
    - "DEFEAT!" テキスト
    - 自動的にリザルト画面へ遷移（2～3秒）
  遷移先: Result（リザルト画面）
```

#### 7. Result（リザルト画面）

```yaml
Result:
  表示内容:
    - Victory / Defeat の明示
    - 獲得報酬（Victoryの場合）
      - ゴールド
      - 経験値
      - ドロップアイテム
    - スコア / クリア時間
    - パフォーマンス評価（★1～★3等）
  ボタン:
    ├─ リトライ → Ready（ステージリセット）
    ├─ 次のステージへ → ステージ選択（次のステージ自動選択）※Victory時のみ
    ├─ ステージ選択 → ステージ選択画面へ
    └─ ホーム → ホーム画面へ
  遷移先:
    - Ready（リトライボタン）
    - ステージ選択（次のステージボタン / ステージ選択ボタン）
    - ホーム（ホームボタン）
```

---

## セーブ・ロード仕様

### セーブシステム設計

#### セーブの種類

```yaml
セーブの種類:
  オートセーブ:
    タイミング:
      - ホーム画面に遷移した際
      - ステージ選択時
      - キャラ強化実行時
      - ガチャ実行時
    動作: 自動的に最新のセーブデータを更新
    スロット: 1個（最新の状態を常に保持）

  マニュアルセーブ:
    タイミング: ユーザーが任意に実行可能
    スロット: 3個まで（ユーザーが選択可能）
    用途: 特定の編成・ステージ攻略状態を保存

  ステージ中セーブ:
    タイミング: ステージ開始時に自動保存
    用途: リトライ時の即座な復帰（ローカル）
    注記: ステージ終了時に削除
```

#### セーブデータ構造（JSON）

```json
{
  "save_version": "1.0.0",
  "timestamp": "2025-12-08T18:00:00Z",
  "player": {
    "user_id": "player_001",
    "user_name": "PlayerName",
    "level": 5,
    "exp": 2500,
    "gold": 10000,
    "gems": 500,
    "first_play": false
  },
  "roster": {
    "characters": [
      {
        "character_id": "char_001",
        "name": "ユニット名",
        "level": 15,
        "skill_level": 3,
        "evolution_stage": 2,
        "rarity": 4,
        "owned": true
      }
    ]
  },
  "decks": {
    "deck_slots": [
      {
        "deck_id": "deck_001",
        "name": "デッキ名",
        "main_units": ["char_001", "char_002", "char_003"],
        "ability_skills": ["skill_001", "skill_002"],
        "sub_units": ["char_004", "char_005", "char_006", "char_007", "char_008"]
      },
      {
        "deck_id": "deck_002",
        "name": "デッキ名2",
        "main_units": ["char_001", "char_003", "char_009"],
        "ability_skills": ["skill_002", "skill_003"],
        "sub_units": ["char_004", "char_006", "char_010", "char_011", "char_012"]
      },
      {
        "deck_id": "deck_003",
        "name": "デッキ名3",
        "main_units": [],
        "ability_skills": [],
        "sub_units": []
      }
    ]
  },
  "stage_progress": {
    "current_stage": "stage_005",
    "completed_stages": ["stage_001", "stage_002", "stage_003", "stage_004"],
    "stage_best_score": {
      "stage_001": {
        "cleared": true,
        "best_time": 45.5,
        "best_rating": 3
      },
      "stage_002": {
        "cleared": true,
        "best_time": 52.3,
        "best_rating": 2
      }
    }
  },
  "settings": {
    "master_volume": 0.8,
    "bgm_volume": 0.7,
    "se_volume": 0.9,
    "language": "ja",
    "difficulty": "normal"
  }
}
```

### ロードシステム設計

#### ロード処理フロー

```
ゲーム起動
  ↓
タイトル画面
  ├─ 「続きから」
  │   ↓
  │ セーブデータ一覧表示
  │   ├─ スロット1: [セーブ日時] [プレイヤー名] [レベル]
  │   ├─ スロット2: [セーブ日時] [プレイヤー名] [レベル]
  │   ├─ スロット3: [セーブ日時] [プレイヤー名] [レベル]
  │   └─ [オートセーブ]: [最新セーブ日時]
  │   ↓
  │ セーブ選択 → ロード実行 → ホーム表示
  │
  └─ 「新規ゲーム」
      ↓
    新規セーブデータ生成 → ホーム表示
```

#### ロード対象データ

| データ | ロード時期 | 永続化対象 |
|--------|----------|----------|
| プレイヤー情報（レベル、ゴールド） | ゲーム起動時 | ✅ セーブファイル |
| キャラクター情報（所持、レベル、スキルレベル） | ゲーム起動時 | ✅ セーブファイル |
| デッキ編成 | ゲーム起動時 | ✅ セーブファイル |
| ステージ進捗 | ゲーム起動時 | ✅ セーブファイル |
| 設定（音量、言語） | ゲーム起動時 | ✅ セーブファイル |
| ステージ中データ | ステージ開始時 | ❌ ローカル（メモリ） |
| 敵配置・ウェーブ情報 | ステージ開始時 | ✅ ステージデータ（外部 JSON） |

---

## データ永続化

### ファイル構成

```
SimpleTDCGame_NewArch/
├─ bin/
│   └─ game.exe
├─ data/
│   ├─ saves/                          # セーブデータ
│   │   ├─ autosave.json              # オートセーブ
│   │   ├─ slot_001.json              # マニュアルセーブ1
│   │   ├─ slot_002.json              # マニュアルセーブ2
│   │   └─ slot_003.json              # マニュアルセーブ3
│   ├─ config/
│   │   └─ settings.json              # ゲーム設定（セーブから独立）
│   ├─ characters/                     # キャラクター定義（マスターデータ）
│   │   └─ characters.json
│   ├─ stages/                         # ステージ定義（マスターデータ）
│   │   └─ stages.json
│   ├─ skills/                         # スキル定義（マスターデータ）
│   │   └─ skills.json
│   ├─ effects/                        # エフェクト定義（マスターデータ）
│   │   └─ effects.json
│   └─ sounds/                         # サウンド定義（マスターデータ）
│       └─ sounds.json
└─ ...
```

### セーブファイル管理

#### セーブ処理

```cpp
// 概念的な実装フロー
SaveData save_data;
save_data.player = get_current_player();
save_data.roster = get_current_roster();
save_data.decks = get_current_decks();
save_data.stage_progress = get_stage_progress();
save_data.settings = get_settings();

// JSON シリアライズ
nlohmann::json json_data = save_data.to_json();

// ファイル出力
std::ofstream file("data/saves/autosave.json");
file << json_data.dump(2);
file.close();
```

#### ロード処理

```cpp
// JSON ファイル読み込み
std::ifstream file("data/saves/autosave.json");
nlohmann::json json_data;
file >> json_data;
file.close();

// デシリアライズ
SaveData save_data = SaveData::from_json(json_data);

// ゲーム状態復元
apply_player_data(save_data.player);
apply_roster_data(save_data.roster);
apply_deck_data(save_data.decks);
apply_stage_progress(save_data.stage_progress);
apply_settings(save_data.settings);
```

### エラーハンドリング

```yaml
エラーシナリオ:
  セーブファイル破損:
    対応: エラーダイアログ → タイトル画面へ戻す
    オプション: バックアップから復元

  セーブファイル存在しない:
    対応: 新規ゲーム扱いで初期化

  セーブ版バージョン不一致:
    対応: マイグレーション処理（互換性維持）
         または新規ゲーム強制
```

---

## まとめ

### フロー図（全体）

```
[タイトル] ─ 新規 ─→ [チュートリアル] ─→ [ホーム]
   ↑                                       ↓
   └─ 続きから ← [ロード] ← [セーブ]  ← [ホーム] ← [リザルト]
                                           ↓
                                    [ステージ選択]
                                           ↓
                                    [編成確認]
                                           ↓
                                    [TDゲーム]
```

### 次のステップ

- [ ] キャラクター・ステージ・スキルの JSON スキーマ確定
- [ ] ユニット出撃システムの詳細（CP 計算、クールタイム）
- [ ] スキルシステムの効果種類・範囲定義
- [ ] 敵 AI・ウェーブシステムの仕様
- [ ] Core/Game/TD 3層の責務範囲確定

