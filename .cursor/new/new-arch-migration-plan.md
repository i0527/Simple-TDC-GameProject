# 新アーキテクチャ再構成プラン

## 目的

- ImGui内部エディタを中核に据え、ゲームコンテンツ編集〜反映をゲーム内で完結。
- JSON駆動（データ志向）で3基幹システム（直線TD・マップTD・UI定義）を拡張可能にする。
- include/src に `new/` 階層を作り、新設計をそこへ実装。旧コードは新が追いつくまで保持し、CMakeで両ビルドを並行維持。
- 今回の設計ドキュメントは `.cursor/new/` に保存。

## 実施ステップ

1) ディレクトリとビルドターゲットの土台

- `include/new/`, `src/new/` を追加し、新アーキテクチャのコードを隔離。
- CMakeに新ターゲット（例: `SimpleTDCGame_NewArchNext`）を追加し、既存ターゲットと並行ビルド可能にする。
- アセット/JSON読込パスを既存と衝突しないようオプション化。

2) 新アーキテクチャのコア方針を確定

- ECS/DI: `GameContext` を new 配下に再定義し、システムへ依存注入。Singleton禁止を徹底。
- データ層: JSONスキーマ（entities/waves/abilities/ui）を new で定義、ローダとバリデータを分離。
- レンダ/入力: 仮想FHD→スケーリングの責務を `RenderSystem`(new) で固定し、入力座標の逆変換をユーティリティ化。

3) 内部エディタ統合（new側）

- `src/new/Game/Editor/` に DevMode/Editors/HotReload/Workspace を再配置し、F1〜F4ショートカット切替＋固定3ペイン＋タイムライン構成を実装（DockSpace廃止）。
- JSON編集UI（一覧＋プロパティ＋生JSONビュー）とホットリロードを統合。ゲームビューは RenderTexture を ImGui に埋め込み。
- `.cursor/new/` にエディタ仕様と操作ガイドを保存。

4) TD(直線型→マップ型)とUIシステムの段階移植

- 直線型TD: スポーン/波/レーン/コスト管理を new ECS で最小プレイ可能まで移植。
- マップ型TD: グリッド/パス/敵経路設定を JSON で定義し、UIと共有する。
- UIシステム: UIレイアウト/スキン/アニメを JSON で定義し、エディタで編集可能にする。

5) 移行と削除の条件定義

- 段階的パリティチェック: 旧ターゲットと new ターゲットで同等プレイフローを確認。
- パリティ達成後に旧コード/ターゲットを削除（Roguelikeは残さず、新TD/UIに集中）。
- ドキュメントの更新先を `.cursor/new/` にまとめ、旧ドキュメントは `docs/archive/` に移送。

## 補足

- 既存のRoguelike要素は新アーキテクチャには持ち込まず、旧側にのみ残留したまま最終的に削除。
- JSON解析は例外ハンドリング必須、DI徹底、PODコンポーネント方針は `.cursorrules` に準拠。
