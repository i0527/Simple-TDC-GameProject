# Motion Editor 要件（新規）

## ゴール/スコープ（オフライン同人規模）

- 入出力JSONを明確化し、ゲーム側と同一パイプラインで再生・HotReloadできること。
- パーツベースのモーション（ポーズ列＋メタ）を編集・プレビューし、F1/F4ビューワと整合すること。
- デバッグ/チート系はDev/Debugビルド限定。リリースではエディタ機能を無効化。

## 入出力

- 入力: `assets/motions/<character>.json`（CharacterMotionData）を読み込み。
- 出力: 同一形式で上書き保存/別名保存。保存時にドラフトの検証を実行し、失敗時は書き込まない。
- 参照: `assets/characters/<character>/states.json`（状態テーブル）をオプション参照。存在しない場合は状態タブをグレーアウト。

## データモデル（抜粋）

- CharacterMotionData:
  - `parts[]`: パーツID・テクスチャ・初期トランスフォーム。
  - `clips[]`: `id`, `fps`, `loop`, `frames[]`（各パーツの姿勢: pos/rot/scale/z/flip/alpha）、`transitionTags`。
  - `events[]`（任意）: フレーム位置と `type`（`hitbox_on/off`/`particle`/`sound`/`custom`）＋ `args`。
- 互換: 未知キーは無視、欠落は既定値で補完。致命エラー時は読み取り専用で警告。

## 編集機能（最低限）

- タイムライン: クリップ選択、fps/loop切替、フレーム追加/削除/コピー、パーツ毎のキーフレーム編集。
- パーツ編集: pos/rot/scale/z/flip/alpha をギズモ/数値で編集。複数選択・一括オフセット。
- イベント編集: `hitbox_on/off`/`particle`/`sound`/`custom` をフレームに配置・移動。粒度=1フレーム。
- プレビュー: 再生/一時停止/ループ、スローモーション、フレームスクラブ。背景切替（透明/グリッド）。
- Undo/Redo: ローカル履歴（最小100ステップ）。保存前の警告。

## HotReload / 検証フロー

- 監視: `assets/motions/*.json`。変更検出 → スキーマ検証 → ネイティブ変換 → 適用。部分失敗は「partial」で通知し、前回キャッシュを保持。
- 保存時: スキーマ検証必須。失敗時は保存せずエラー表示。成功時にゲーム側へHotReloadトリガを送信。
- ステージ/編成と連動: キャラ参照が存在しない場合はエラー表示し、旧キャッシュを使い続ける。

## UI/レイアウト（F1/F4整合）

- F1（ゲームデバッグ）: 状態/イベントログ表示と同期。再生中のクリップ名/フレーム/イベントをオーバーレイ。
- F4（Motion Editor）: 左パーツツリー、中タイムライン、右プロパティ。プレビューはゲームと同一レンダリング経路（RenderTexture共有）。
- パネル: クリップ一覧、イベントリスト（種類フィルタ）、エラーパネル（検証結果/HotReload結果）。

## ランタイム連携

- `AnimationRegistryCache` に保存後のクリップを即時反映。`AnimationPlaybackSystem` と `AnimationEventSystem` が同データを参照。
- イベントの優先順位は `hitbox_on/off` → `particle` → `sound` → `custom`（同種は定義順）。

## パフォーマンス/安定性

- 目標: タイムライン操作で 60FPS（エディタUI含む）。プレビューはキャッシュ済みテクスチャを再利用。
- 大規模データ保護: 1ファイル上限は現状 10MB 程度を目安。超過時は警告。

## 非対応（明示）

- セーブ改変検知、ネットワーク同期、マルチユーザ編集、リプレイ生成、課金/広告連携はスコープ外。
