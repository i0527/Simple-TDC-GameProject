# アーキテクチャ図解集

**最終更新**: 2025-12-03  
**用途**: プロジェクト全体のアーキテクチャを視覚的に理解する

---

## 目次

1. [システム全体図](#1-システム全体図)
2. [レイヤーアーキテクチャ](#2-レイヤーアーキテクチャ)
3. [ECS データフロー](#3-ecs-データフロー)
4. [依存性注入パターン](#4-依存性注入パターン)
5. [ビルドターゲット関係](#5-ビルドターゲット関係)
6. [マルチエージェント開発フロー](#6-マルチエージェント開発フロー)
7. [シーン遷移図](#7-シーン遷移図)
8. [リファクタリング戦略](#8-リファクタリング戦略)

---

## 1. システム全体図

```
┌─────────────────────────────────────────────────────────────────┐
│                      Simple-TDC-GameProject                      │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│SimpleTDCGame  │   │SimpleTDCGame  │   │ NetHackGame   │
│   (旧版)      │   │  _NewArch     │   │  (Roguelike)  │
│               │   │   (新版)      │   │               │
│ 状態: 保守    │   │ 状態: 推奨 ✅ │   │ 状態: 開発中  │
└───────────────┘   └───────────────┘   └───────────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │         共通基盤 (Core Layer)             │
        │  - ECS (EnTT)                           │
        │  - DI Container                         │
        │  - Resource Management                  │
        │  - Rendering                            │
        │  - Config                               │
        └─────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│    EnTT       │   │   Raylib      │   │nlohmann/json  │
│  (v3.12.2)    │   │   (v5.0)      │   │  (v3.11.2)    │
└───────────────┘   └───────────────┘   └───────────────┘
```

---

## 2. レイヤーアーキテクチャ

### 2.1 全体構造

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  Application Layer (アプリケーション層)         ┃
┃  ┌─────────┐  ┌─────────┐  ┌─────────┐        ┃
┃  │  Game   │  │ GameNew │  │Roguelike│        ┃
┃  │  (旧)   │  │  (新)   │  │  Game   │        ┃
┃  └─────────┘  └─────────┘  └─────────┘        ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                    ↓
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  Domain Layer (ドメイン層)                     ┃
┃  ┌─────────────────┐  ┌─────────────────┐    ┃
┃  │   TD Layer      │  │ Roguelike Layer │    ┃
┃  │  - Components   │  │  - Components   │    ┃
┃  │  - Systems      │  │  - Systems      │    ┃
┃  │  - Logic        │  │  - Generation   │    ┃
┃  └─────────────────┘  └─────────────────┘    ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                    ↓
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  Game Layer (ゲーム層)                         ┃
┃  - Sprite System                              ┃
┃  - Animation System                           ┃
┃  - Scene Management                           ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                    ↓
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  Core Layer (コア層)                           ┃
┃  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┃
┃  │  ECS   │ │   DI   │ │Render  │ │ Config │ ┃
┃  │        │ │        │ │        │ │        │ ┃
┃  └────────┘ └────────┘ └────────┘ └────────┘ ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                    ↓
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  External Libraries (外部ライブラリ)            ┃
┃  [EnTT] [Raylib] [nlohmann/json] [ImGui]     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

### 2.2 依存関係のルール

```
✅ 許可される依存:
Application → Domain → Game → Core → External
     ↓          ↓        ↓       ↓        ↓
   (OK)      (OK)      (OK)    (OK)     (OK)

❌ 禁止される依存:
Core → Domain    (下から上への依存)
Game → TD        (横への依存)
```

---

## 3. ECS データフロー

### 3.1 基本構造

```
┌─────────────────────────────────────────────────┐
│              entt::registry                     │
│  (全エンティティとコンポーネントを管理)            │
└─────────────────────────────────────────────────┘
                    │
       ┌────────────┼────────────┐
       │            │            │
       ▼            ▼            ▼
┌──────────┐ ┌──────────┐ ┌──────────┐
│ Entity 1 │ │ Entity 2 │ │ Entity 3 │
└──────────┘ └──────────┘ └──────────┘
       │            │            │
       ▼            ▼            ▼
  Components   Components   Components
  ┌─────────┐  ┌─────────┐  ┌─────────┐
  │Transform│  │Transform│  │Transform│
  │Velocity │  │Health   │  │Velocity │
  │Sprite   │  │AI       │  │Enemy    │
  └─────────┘  └─────────┘  └─────────┘
```

### 3.2 システムによる処理フロー

```
Frame Start
    │
    ▼
┌────────────────────┐
│  ProcessInput()    │  ← InputSystem
│  - キー入力        │
│  - マウス入力      │
└────────────────────┘
    │
    ▼
┌────────────────────┐
│  Update()          │  ← 各種システム
│                    │
│  MovementSystem ───┼─→ Transform + Velocity
│  CollisionSystem ──┼─→ Transform + Collider
│  AISystem ─────────┼─→ Transform + AI
│  HealthSystem ─────┼─→ Health + Damage
│                    │
└────────────────────┘
    │
    ▼
┌────────────────────┐
│  Render()          │  ← RenderSystem
│  - スプライト描画  │     Transform + Sprite
│  - UI描画          │
└────────────────────┘
    │
    ▼
Frame End
```

### 3.3 コンポーネント間の関係

```
┌────────────────────────────────────────────┐
│         Entity (Player)                    │
├────────────────────────────────────────────┤
│  Transform                                 │
│    x, y, rotation, scale                   │
├────────────────────────────────────────────┤
│  Velocity                                  │
│    dx, dy                                  │
├────────────────────────────────────────────┤
│  Health                                    │
│    current, maximum                        │
├────────────────────────────────────────────┤
│  Sprite                                    │
│    texture, width, height                  │
├────────────────────────────────────────────┤
│  PlayerControlled                          │
│    speed                                   │
└────────────────────────────────────────────┘
        │
        ▼ システムによる処理
        │
┌───────┴─────────────────────────────────┐
│                                         │
InputSystem        MovementSystem    RenderSystem
    │                  │                  │
    ▼                  ▼                  ▼
Velocity に      Transform を       Sprite を
速度を設定        更新              描画
```

---

## 4. 依存性注入パターン

### 4.1 Singleton パターン（非推奨）

```
❌ 悪い例: グローバルな状態

┌─────────────┐
│ConfigManager│ ← Singleton
│(static)     │
└─────────────┘
     ▲  ▲  ▲
     │  │  │
┌────┴┐ │ ┌┴────┐
│Sys1 │ │ │Sys3 │
└─────┘ │ └─────┘
        │
    ┌───┴──┐
    │ Sys2 │
    └──────┘

問題:
- テストが困難
- 依存関係が不明確
- 並列処理で問題
```

### 4.2 依存性注入パターン（推奨）

```
✅ 良い例: 明示的な依存関係

        ┌─────────────┐
        │ ConfigManager│ ← 通常のクラス
        └──────┬──────┘
               │ 注入
      ┌────────┼────────┐
      │        │        │
      ▼        ▼        ▼
  ┌─────┐  ┌─────┐  ┌─────┐
  │Sys1 │  │Sys2 │  │Sys3 │
  └─────┘  └─────┘  └─────┘

利点:
- テスト容易
- 依存関係が明確
- モック可能
```

### 4.3 実装パターン

```cpp
// GameNew クラスでの DI 実装

┌──────────────────────────────┐
│         GameNew              │
├──────────────────────────────┤
│ - configManager_             │ ← 所有
│ - resourceManager_           │ ← 所有
│ - systems_                   │ ← 所有
└──────────────────────────────┘
         │
         │ コンストラクタで注入
         ▼
┌──────────────────────────────┐
│      RenderSystem            │
├──────────────────────────────┤
│ - resourceManager_&          │ ← 参照で保持
└──────────────────────────────┘
         │
         │ 使用
         ▼
┌──────────────────────────────┐
│    ResourceManager           │
├──────────────────────────────┤
│ - textures_                  │
│ - fonts_                     │
└──────────────────────────────┘
```

---

## 5. ビルドターゲット関係

### 5.1 3つのターゲット

```
┌─────────────────────────────────────────────┐
│         CMakeLists.txt                      │
└─────────────────────────────────────────────┘
                    │
      ┌─────────────┼─────────────┐
      │             │             │
      ▼             ▼             ▼
┌───────────┐ ┌───────────┐ ┌───────────┐
│SimpleTDC  │ │SimpleTDC  │ │ NetHack   │
│  Game     │ │Game_NewArch│ │  Game     │
│           │ │           │ │           │
│ ❌ 非推奨  │ │ ✅ 推奨    │ │ 🚧 開発中  │
└───────────┘ └───────────┘ └───────────┘
      │             │             │
      ▼             ▼             ▼
┌───────────┐ ┌───────────┐ ┌───────────┐
│main.cpp   │ │main_new   │ │main_      │
│Game.cpp   │ │.cpp       │ │roguelike  │
│(旧アーキ)  │ │GameNew.cpp│ │.cpp       │
└───────────┘ └───────────┘ └───────────┘
      │             │             │
      └─────────────┼─────────────┘
                    │
                    ▼
          ┌─────────────────┐
          │  Common Sources │
          │ - ConfigManager │
          │ - ResourceMgr   │
          └─────────────────┘
```

### 5.2 移行戦略（Strangler Fig Pattern）

```
Phase 1: 共存期 (現在)
┌────────────┐  ┌────────────┐  ┌────────────┐
│    旧      │  │    新      │  │ Roguelike  │
│ 保守のみ   │  │ 推奨 ⭐    │  │  開発開始  │
└────────────┘  └────────────┘  └────────────┘
     ↓               ↓               ↓

Phase 2: 移行期 (1-2ヶ月後)
┌────────────┐  ┌────────────┐  ┌────────────┐
│    旧      │  │    新      │  │ Roguelike  │
│ 非推奨警告 │  │ メイン開発 │  │ Phase 1-3  │
└────────────┘  └────────────┘  └────────────┘
     ↓               ↓               ↓

Phase 3: 完了期 (3ヶ月後)
                ┌────────────┐  ┌────────────┐
      削除 →    │SimpleTDCGame│ │ NetHackGame│
                │ (新版)     │  │  (統合)    │
                └────────────┘  └────────────┘
```

---

## 6. マルチエージェント開発フロー

### 6.1 エージェント協調モデル

```
┌─────────────────────────────────────────────────┐
│              開発タスク                          │
└─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────┐
│ Step 1: 設計                                     │
│ ┌──────────────────────────────────────────┐   │
│ │ エージェント: アーキテクト                 │   │
│ │ 成果物: 設計ドキュメント                   │   │
│ └──────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────┐
│ Step 2: 実装                                     │
│ ┌──────────────┐ ┌──────────────┐             │
│ │コーダー1     │ │コーダー2     │  (並列)     │
│ │Component実装 │ │System実装    │             │
│ └──────────────┘ └──────────────┘             │
└─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────┐
│ Step 3: レビュー                                 │
│ ┌──────────────────────────────────────────┐   │
│ │ エージェント: リファクター                 │   │
│ │ 作業: コードレビュー、改善                 │   │
│ └──────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
                    │
          ┌─────────┴─────────┐
          │                   │
          ▼                   ▼
┌──────────────────┐ ┌──────────────────┐
│ Step 4: 文書化   │ │ Step 5: テスト   │
│ ドキュメンター   │ │ テスター         │
│ API文書作成      │ │ 単体テスト作成   │
└──────────────────┘ └──────────────────┘
```

### 6.2 並列処理可能なタスク

```
                  ┌─ Task A ─┐
                  │ Component│
                  │  実装    │
                  └──────────┘
                       │
     ┌─────────────────┼─────────────────┐
     │                 │                 │
     ▼                 ▼                 ▼
┌─────────┐      ┌─────────┐      ┌─────────┐
│Coder 1  │      │Coder 2  │      │Coder 3  │
│Movement │      │Render   │      │Collision│
│System   │      │System   │      │System   │
└─────────┘      └─────────┘      └─────────┘
     │                 │                 │
     └─────────────────┼─────────────────┘
                       │
                       ▼
                  ┌─────────┐
                  │ 統合    │
                  │ テスト  │
                  └─────────┘
```

---

## 7. シーン遷移図

```
┌──────────┐
│  起動    │
└────┬─────┘
     │
     ▼
┌──────────┐
│Title     │ ─┐
│Scene     │  │
└────┬─────┘  │
     │        │ ESC キー
     ▼        │
┌──────────┐  │
│Home      │ ◄┘
│Scene     │
└────┬─────┘
     │
     ├─→ TD Game Selected
     │   ┌──────────┐
     │   │TD Game   │
     │   │Scene     │
     │   └──────────┘
     │
     ├─→ Roguelike Selected
     │   ┌──────────┐
     │   │Roguelike │
     │   │Scene     │
     │   └──────────┘
     │
     └─→ Settings Selected
         ┌──────────┐
         │Settings  │
         │Scene     │
         └──────────┘
```

---

## 8. リファクタリング戦略

### 8.1 優先順位マトリクス

```
        影響度
        大 │ 中 │ 小
    ────┼───┼───┼───
緊  大  │🔴│🟡│🟢│
急      │   │   │   │
度  中  │🟡│🟡│🟢│
        │   │   │   │
    小  │🟡│🟢│⚪│
    ────┴───┴───┴───

🔴 最優先 (Phase 1)
- アーキテクチャ混在
- コンポーネント重複

🟡 重要 (Phase 2)
- Singleton削減
- テストインフラ

🟢 将来 (Phase 3)
- パフォーマンス最適化
- WebUIエディタ
```

### 8.2 段階的移行フロー

```
Current State
┌─────────────────────────────────────┐
│ 旧アーキ    新アーキ    Roguelike    │
│  (混在)     (部分)     (未実装)      │
└─────────────────────────────────────┘
              │
              ▼ Phase 1 (1-2週間)
┌─────────────────────────────────────┐
│ 基盤整理                             │
│ - ComponentsNew.h 統一               │
│ - ドキュメント整備                   │
│ - ビルドターゲット明確化             │
└─────────────────────────────────────┘
              │
              ▼ Phase 2 (1-2ヶ月)
┌─────────────────────────────────────┐
│ 新アーキ統一                         │
│ - 旧アーキ非推奨化                   │
│ - Singleton → DI                    │
│ - Roguelike Phase 1-3               │
└─────────────────────────────────────┘
              │
              ▼ Phase 3 (3ヶ月〜)
┌─────────────────────────────────────┐
│ 完成形                               │
│ - 旧アーキ削除                       │
│ - テストインフラ整備                 │
│ - パフォーマンス最適化               │
└─────────────────────────────────────┘

Target State
┌─────────────────────────────────────┐
│  SimpleTDCGame    NetHackGame       │
│   (統一アーキ)     (完成)           │
└─────────────────────────────────────┘
```

---

## 付録: フォルダ構造可視化

```
Simple-TDC-GameProject/
│
├── .cursor/                    # Cursor IDE 設定
│   ├── CURSOR_DEVELOPMENT_GUIDE.md
│   ├── AI_AGENT_QUICK_REFERENCE.md
│   └── ARCHITECTURE_DIAGRAMS.md (本ファイル)
│
├── .github/
│   ├── workflows/              # CI/CD
│   └── copilot-instructions.md # コーディング規約
│
├── docs/                       # ドキュメント
│   ├── EXECUTIVE_SUMMARY.md   # 概要
│   ├── CODE_ANALYSIS.md       # 分析
│   ├── REFACTORING_PLAN.md    # 改善計画
│   └── README.md              # 索引
│
├── include/                   # ヘッダー
│   ├── Core/                  # コア層
│   │   ├── Components/
│   │   ├── Systems/
│   │   └── System.h
│   ├── Game/                  # ゲーム層
│   ├── TD/                    # タワーディフェンス層
│   ├── Roguelike/             # ローグライク層
│   └── ComponentsNew.h        # 統合ヘッダー
│
├── src/                       # ソース
│   ├── main.cpp              # 旧版エントリポイント
│   ├── main_new.cpp          # 新版エントリポイント ⭐
│   └── main_roguelike.cpp    # Roguelike エントリポイント
│
├── assets/                    # アセット
│   ├── config.json
│   ├── fonts/
│   └── textures/
│
├── build/                     # ビルド出力 (Git無視)
│
├── CMakeLists.txt            # ビルド設定
├── .cursorrules              # Cursor ルール
└── README.md                 # プロジェクトREADME
```

---

**この図解集を参照して、プロジェクトの構造を理解してください！**
