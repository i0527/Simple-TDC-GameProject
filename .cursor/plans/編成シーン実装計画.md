---
name: 編成シーン実装計画
overview: HomeSceneの編成タブに、ユニット編成機能を実装する。スロットへの配置、候補ユニット一覧、プレビュー、ステータス表示、ドラッグ&ドロップ操作を実装する。
todos:
  - id: data-structure
    content: 編成データ構造の定義とロード機能を実装
    status: pending
  - id: unit-data-loader
    content: ユニット定義データのロード機能を実装
    status: pending
  - id: ui-layout
    content: 編成UIレイアウト（スロット、候補一覧、プレビュー、ステータス）の設計と実装
    status: pending
  - id: slot-rendering
    content: 編成スロットの描画機能を実装
    status: pending
  - id: candidate-list
    content: 候補ユニット一覧の描画とスクロール機能を実装
    status: pending
  - id: preview-panel
    content: 選択ユニットのプレビュー表示機能を実装
    status: pending
  - id: status-panel
    content: ユニットステータス表示パネルを実装
    status: pending
  - id: drag-drop
    content: ドラッグ&ドロップ操作の実装
    status: pending
  - id: click-place
    content: クリック配置機能の実装
    status: pending
  - id: save-load
    content: 編成データの保存・読み込み機能を実装
    status: pending
  - id: input-handling
    content: マウス・キーボード入力処理を実装
    status: pending
  - id: visual-feedback
    content: ホバー、選択、ドラッグ中の視覚的フィードバックを実装
    status: pending
---

# 編成シーン実装計画

## 1. 概要

`HomeScene`の編成タブ（`FORMATION`）に、ユニット編成機能を実装する。
プレイヤーが最大10個のスロットにユニットを配置し、戦闘で使用する編成を作成できるようにする。

### 機能要件

- **編成スロット**: 最大10個のスロットにユニットを配置
- **候補ユニット一覧**: 所有しているユニットを一覧表示
- **プレビュー**: 選択したユニットの詳細情報を表示
- **ステータス表示**: HP、攻撃力、コストなどのステータスを表示
- **ドラッグ&ドロップ**: 候補からスロットへドラッグ&ドロップで配置
- **クリック配置**: 候補をクリックして空きスロットに配置
- **編成保存**: 編成データをJSONファイルに保存
- **編成読み込み**: 保存された編成データを読み込み

## 2. データ構造

### 2.1 編成データ構造

```cpp
// game/scenes/FormationData.hpp
namespace game {
    namespace scenes {
        /// @brief 編成スロット
        struct FormationSlot {
            std::string unitId;      // 配置されたユニットID（空文字列で空き）
            int slotIndex;           // スロットインデックス（0-9）
            bool isEmpty() const { return unitId.empty(); }
        };

        /// @brief 編成データ
        struct FormationData {
            std::string presetName = "default";
            int maxSlots = 10;
            std::vector<FormationSlot> slots;
            std::vector<std::string> candidates;  // 候補ユニットIDリスト
            
            /// @brief 空きスロットの数を取得
            int getEmptySlotCount() const;
            
            /// @brief 指定スロットにユニットを配置
            bool placeUnit(int slotIndex, const std::string& unitId);
            
            /// @brief 指定スロットからユニットを削除
            void removeUnit(int slotIndex);
            
            /// @brief 編成データをJSONにシリアライズ
            nlohmann::json toJson() const;
            
            /// @brief JSONから編成データをデシリアライズ
            static FormationData fromJson(const nlohmann::json& json);
        };
    }
}
```

### 2.2 ユニット定義データ構造

```cpp
// game/data/UnitDefinition.hpp
namespace game {
    namespace data {
        /// @brief ユニット定義データ
        struct UnitDefinition {
            std::string id;              // ユニットID
            std::string name;            // 表示名
            std::string description;     // 説明文
            int rarity;                  // レアリティ（1-5）
            std::string type;            // タイプ（"sub"など）
            int cost;                    // コスト
            float cooldown;              // クールダウン
            
            // ステータス
            struct Stats {
                int hp;
                int attack;
                float attackSpeed;
                int range;
                int moveSpeed;
                int knockback;
            } stats;
            
            // 表示情報
            std::string iconPath;        // アイコンパス
            std::vector<std::string> tags;  // タグ
            
            /// @brief JSONからユニット定義を読み込み
            static UnitDefinition fromJson(const nlohmann::json& json);
        };
    }
}
```

## 3. UIレイアウト設計（FHD 1920×1080）

### 3.1 レイアウト構成

```
┌─────────────────────────────────────────────────────────────┐
│ ヘッダー（既存）                                             │
├─────────────────────────────────────────────────────────────┤
│ タブバー（既存）                                             │
├──────────┬──────────────────────────┬───────────────────────┤
│          │                          │                       │
│ 強化/    │  プレビューエリア         │  候補ユニット一覧     │
│ ステータス│  (400×400px)            │  (スクロール可能)      │
│ パネル   │                          │                       │
│ (300×   │  [選択ユニットの          │  [ユニットカード]      │
│  400px) │   アイコン・名前]          │  [ユニットカード]      │
│          │                          │  [ユニットカード]      │
│          │  編成スロット帯          │  ...                  │
│          │  ┌──┐ ┌──┐ ┌──┐ ┌──┐ ┌──┐│                       │
│          │  │ 1│ │ 2│ │ 3│ │ 4│ │ 5││                       │
│          │  └──┘ └──┘ └──┘ └──┘ └──┘│                       │
│          │  ┌──┐ ┌──┐ ┌──┐ ┌──┐ ┌──┐│                       │
│          │  │ 6│ │ 7│ │ 8│ │ 9│ │10││                       │
│          │  └──┘ └──┘ └──┘ └──┘ └──┘│                       │
│          │  (スロットサイズ: 60×60px)│                       │
│          │                          │                       │
├──────────┴──────────────────────────┴───────────────────────┤
│ 操作ボタン: [保存] [リセット] [プリセット読み込み]            │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 レイアウト計算

```cpp
// game/ui/FormationUILayout.hpp
namespace game {
    namespace ui {
        namespace FormationLayout {
            // 画面サイズ
            constexpr float SCREEN_WIDTH = 1920.0f;
            constexpr float SCREEN_HEIGHT = 1080.0f;
            
            // エリア定義
            constexpr float STATUS_PANEL_X = 40.0f;
            constexpr float STATUS_PANEL_Y = 200.0f;  // ヘッダー・タブバー下
            constexpr float STATUS_PANEL_WIDTH = 300.0f;
            constexpr float STATUS_PANEL_HEIGHT = 400.0f;
            
            constexpr float PREVIEW_X = STATUS_PANEL_X + STATUS_PANEL_WIDTH + 40.0f;
            constexpr float PREVIEW_Y = STATUS_PANEL_Y;
            constexpr float PREVIEW_WIDTH = 400.0f;
            constexpr float PREVIEW_HEIGHT = 400.0f;
            
            constexpr float CANDIDATE_LIST_X = PREVIEW_X + PREVIEW_WIDTH + 40.0f;
            constexpr float CANDIDATE_LIST_Y = STATUS_PANEL_Y;
            constexpr float CANDIDATE_LIST_WIDTH = SCREEN_WIDTH - CANDIDATE_LIST_X - 40.0f;
            constexpr float CANDIDATE_LIST_HEIGHT = 600.0f;
            
            // スロット設定
            constexpr float SLOT_SIZE = 60.0f;
            constexpr float SLOT_SPACING = 10.0f;
            constexpr int SLOTS_PER_ROW = 5;
            constexpr int MAX_SLOTS = 10;
            
            // 候補ユニットカード設定
            constexpr float CANDIDATE_CARD_WIDTH = 120.0f;
            constexpr float CANDIDATE_CARD_HEIGHT = 150.0f;
            constexpr float CANDIDATE_CARD_SPACING = 10.0f;
            constexpr int CANDIDATES_PER_ROW = 6;
        }
    }
}
```

## 4. 実装ステップ

### Phase 1: データ構造とロード機能

1. **FormationData構造体の実装**
   - `game/scenes/FormationData.hpp` / `.cpp`を作成
   - スロット管理、JSONシリアライズ/デシリアライズを実装

2. **UnitDefinition構造体の実装**
   - `game/data/UnitDefinition.hpp` / `.cpp`を作成
   - JSONからユニット定義を読み込む機能を実装

3. **データローダーの実装**
   - `game/data/DataLoader.hpp` / `.cpp`を作成
   - 編成データ、ユニット定義の読み込み機能を実装

### Phase 2: UIレイアウトと描画

4. **レイアウト計算クラスの実装**
   - `game/ui/FormationUILayout.hpp`を作成
   - 各UI要素の座標・サイズを計算する関数を実装

5. **スロット描画機能**
   - `HomeScene::RenderFormationSlots()`を実装
   - 空きスロット、配置済みスロットの描画
   - ホバー・選択状態の視覚的フィードバック

6. **候補ユニット一覧の描画**
   - `HomeScene::RenderCandidateList()`を実装
   - グリッドレイアウトでユニットカードを描画
   - スクロール機能の実装

7. **プレビューパネルの描画**
   - `HomeScene::RenderPreviewPanel()`を実装
   - 選択ユニットのアイコン、名前、説明を表示

8. **ステータスパネルの描画**
   - `HomeScene::RenderStatusPanel()`を実装
   - HP、攻撃力、コストなどのステータスを表示

### Phase 3: 入力処理と操作

9. **マウス入力処理**
   - `HomeScene::HandleFormationMouseInput()`を実装
   - スロットクリック、候補クリックの検出

10. **ドラッグ&ドロップ機能**
    - `HomeScene::HandleDragDrop()`を実装
    - ドラッグ開始、ドラッグ中、ドロップの処理
    - ドラッグ中の視覚的フィードバック

11. **クリック配置機能**
    - 候補ユニットをクリックして空きスロットに配置
    - スロットをクリックしてユニットを削除

12. **キーボード入力処理**
    - ESCキーでドラッグキャンセル
    - Deleteキーで選択スロットからユニット削除

### Phase 4: データ永続化

13. **編成保存機能**
    - `HomeScene::SaveFormation()`を実装
    - `data/definitions/formations/`にJSONファイルとして保存

14. **編成読み込み機能**
    - `HomeScene::LoadFormation()`を実装
    - 保存された編成データを読み込み

15. **プリセット機能**
    - 複数の編成プリセットを保存・読み込み可能にする

### Phase 5: 視覚的フィードバックと調整

16. **アニメーションとエフェクト**
    - スロットへの配置時のエフェクト
    - ホバー時のハイライト
    - ドラッグ中の視覚的フィードバック

17. **UI調整**
    - レイアウトの微調整
    - 色・フォントサイズの調整
    - レスポンシブ対応（解像度変更に対応）

## 5. 実装詳細

### 5.1 HomeSceneへの追加メンバ

```cpp
// HomeScene.hpp に追加
private:
    // 編成データ
    FormationData currentFormation_;
    
    // ユニット定義データ
    std::map<std::string, UnitDefinition> unitDefinitions_;
    
    // UI状態
    int selectedSlotIndex_ = -1;           // 選択中のスロットインデックス
    std::string selectedUnitId_;          // 選択中のユニットID
    std::string draggedUnitId_;           // ドラッグ中のユニットID
    bool isDragging_ = false;              // ドラッグ中フラグ
    Vector2 dragStartPos_;                 // ドラッグ開始位置
    
    // スクロール状態
    float candidateListScrollY_ = 0.0f;    // 候補一覧のスクロール位置
    
    // ホバー状態
    int hoveredSlotIndex_ = -1;            // ホバー中のスロット
    std::string hoveredCandidateId_;       // ホバー中の候補ユニット
    
    // 編成データの読み込み
    void LoadFormationData();
    void LoadUnitDefinitions();
    
    // UI描画
    void RenderFormationSlots();
    void RenderCandidateList();
    void RenderPreviewPanel();
    void RenderStatusPanel();
    void RenderFormationButtons();
    
    // 入力処理
    void HandleFormationMouseInput();
    void HandleFormationKeyboardInput();
    void HandleDragDrop();
    
    // ユーティリティ
    int getSlotIndexAtPosition(Vector2 pos);
    std::string getCandidateIdAtPosition(Vector2 pos);
    Rectangle getSlotBounds(int slotIndex);
    Rectangle getCandidateCardBounds(int candidateIndex);
```

### 5.2 スロット描画の実装例

```cpp
void HomeScene::RenderFormationSlots() {
    auto& renderingManager = services_.getRenderingManager();
    
    float startX = FormationLayout::PREVIEW_X + 
                   (FormationLayout::PREVIEW_WIDTH - 
                    (FormationLayout::SLOTS_PER_ROW * 
                     (FormationLayout::SLOT_SIZE + FormationLayout::SLOT_SPACING) - 
                     FormationLayout::SLOT_SPACING)) / 2.0f;
    float startY = FormationLayout::PREVIEW_Y + 200.0f;
    
    for (int i = 0; i < FormationLayout::MAX_SLOTS; ++i) {
        int row = i / FormationLayout::SLOTS_PER_ROW;
        int col = i % FormationLayout::SLOTS_PER_ROW;
        
        float x = startX + col * (FormationLayout::SLOT_SIZE + FormationLayout::SLOT_SPACING);
        float y = startY + row * (FormationLayout::SLOT_SIZE + FormationLayout::SLOT_SPACING);
        
        Rectangle slotRect = {x, y, FormationLayout::SLOT_SIZE, FormationLayout::SLOT_SIZE};
        
        // スロット背景
        Color bgColor = (i == selectedSlotIndex_) ? Colors::BUTTON_FOCUSED :
                       (i == hoveredSlotIndex_) ? Colors::BUTTON_HOVER :
                       Colors::PANEL_BG;
        DrawRectangleRec(slotRect, bgColor);
        DrawRectangleLinesEx(slotRect, 2.0f, Colors::PANEL_BORDER);
        
        // 配置済みユニットのアイコン
        if (!currentFormation_.slots[i].isEmpty()) {
            const std::string& unitId = currentFormation_.slots[i].unitId;
            if (unitDefinitions_.count(unitId)) {
                const auto& unit = unitDefinitions_.at(unitId);
                // アイコンを描画
                // TODO: アイコン画像の読み込みと描画
            }
        }
        
        // スロット番号
        std::string slotNum = std::to_string(i + 1);
        renderingManager.DrawTextDefault(slotNum.c_str(), 
                                         x + 5, y + 5, 16, Colors::TEXT_SECONDARY);
    }
}
```

### 5.3 ドラッグ&ドロップの実装例

```cpp
void HomeScene::HandleDragDrop() {
    Vector2 mousePos = GetMousePosition();
    
    if (IsMouseButtonPressed(MOUSE_BUTTON_LEFT)) {
        // ドラッグ開始判定
        std::string candidateId = getCandidateIdAtPosition(mousePos);
        if (!candidateId.empty()) {
            isDragging_ = true;
            draggedUnitId_ = candidateId;
            dragStartPos_ = mousePos;
        }
    }
    
    if (isDragging_) {
        // ドラッグ中
        if (IsMouseButtonDown(MOUSE_BUTTON_LEFT)) {
            // ドラッグ中の視覚的フィードバック
            // TODO: ドラッグ中のユニットアイコンを描画
        } else if (IsMouseButtonReleased(MOUSE_BUTTON_LEFT)) {
            // ドロップ判定
            int slotIndex = getSlotIndexAtPosition(mousePos);
            if (slotIndex >= 0 && slotIndex < FormationLayout::MAX_SLOTS) {
                // スロットに配置
                currentFormation_.placeUnit(slotIndex, draggedUnitId_);
            }
            isDragging_ = false;
            draggedUnitId_.clear();
        }
    }
    
    if (IsKeyPressed(KEY_ESCAPE) && isDragging_) {
        // ESCキーでキャンセル
        isDragging_ = false;
        draggedUnitId_.clear();
    }
}
```

## 6. ファイル構成

```
game/
├── scenes/
│   ├── HomeScene.hpp          # 編成タブのメンバ追加
│   └── HomeScene.cpp          # 編成タブの実装
├── data/
│   ├── FormationData.hpp      # 編成データ構造
│   ├── FormationData.cpp
│   ├── UnitDefinition.hpp     # ユニット定義構造
│   ├── UnitDefinition.cpp
│   ├── DataLoader.hpp         # データローダー
│   └── DataLoader.cpp
└── ui/
    └── FormationUILayout.hpp  # レイアウト定義

data/
└── definitions/
    └── formations/
        ├── default.json        # デフォルト編成
        └── preset1.json        # プリセット1
```

## 7. テスト項目

- [ ] 編成データの読み込み・保存が正常に動作する
- [ ] スロットへのユニット配置が正常に動作する
- [ ] スロットからのユニット削除が正常に動作する
- [ ] ドラッグ&ドロップ操作が正常に動作する
- [ ] クリック配置が正常に動作する
- [ ] 候補一覧のスクロールが正常に動作する
- [ ] プレビューパネルに正しい情報が表示される
- [ ] ステータスパネルに正しい情報が表示される
- [ ] 視覚的フィードバック（ホバー、選択）が正常に動作する
- [ ] 最大10個のスロット制限が正しく機能する
- [ ] 編成の保存・読み込みが正常に動作する

## 8. 注意事項

- 既存の`HomeScene`の構造を壊さないように注意する
- レイアウトはFHD（1920×1080）を基準とするが、将来的な解像度変更に対応できるように設計する
- ユニット定義データの読み込みは非同期でも良いが、UI表示前に完了している必要がある
- 編成データの保存は、プレイヤーの操作に応じて自動保存するか、明示的な保存ボタンを提供するか検討する
- パフォーマンスに注意し、大量の候補ユニットがある場合でもスムーズに動作するようにする
