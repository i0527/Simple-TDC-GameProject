# ゲーム状態管理・ステージシステム設計

> 目的: プレイ前→プレイ中→ポーズ→クリア/ゲームオーバーまでの状態管理と、ステージ定義（ウェーブ、ボス、リソース、難易度）を統合する。

## ゴール

- ゲーム全体の状態遷移を明文化し、UI/入力/サウンドを同期。
- ステージ定義を JSON で管理し、ウェーブや難易度を HotReload 可能にする。
- TD固有のライフ/コスト/到達判定と結びつける。

## コアループと勝敗条件

- フロー: ステージ選択 → ロード → Ready演出 → Playing(速度 0.5/1/2x) → Victory/Defeat → リザルト → リトライ/戻る。
- 勝利条件: すべてのウェーブを完了し、敵が全滅。
- 敗北条件: ライフ0 または 制限時間切れ（ステージ定義でオプション）。
- 報酬: Victory 時にステージ報酬テーブルを参照（ゴールド/経験値/アイテム）。敗北時はリトライ提示のみ。

## 状態遷移

```
Boot → MainMenu → StageLoading → StageReady
    → Playing ↔ Paused
    → Victory | Defeat
```

- `Boot`: アセット/定義ロード、Config。
- `MainMenu`: ステージ選択、設定。
- `StageLoading`: ステージJSONロード、Wave/Cost/Lane 初期化。
- `StageReady`: 開始前演出、カウントダウン、UI初期化。
- `Playing`: 通常進行。速度変更(0.5x/1x/2x)を許可。
- `Paused`: 入力/進行停止、UIのみ。
- `Victory`: クリア演出、リザルト表示。
- `Defeat`: ライフ0または強制失敗で遷移。

## 戦闘GameStateの責務と優先度（シーンと分離）

- 適用範囲: 戦闘シーン内のみで `GameStateComponent.state` を `Loading/Ready/Playing/Paused/Victory/Defeat` に保持。シーン遷移（戦闘→リザルトなど）とは分離し、`GameStateSystem` が状態遷移を管理する。
- `pendingTransition` 適用タイミング: 原則フレーム終端（Update 後）で適用。例外として `Critical`（エラー/緊急停止）は Update 前に即時適用。
- 優先度: `Critical > System（ロード完了・死亡確定） > User（UI/入力）`。同一フレームで競合した場合は高優先度を採用し、低優先度は次フレームへ持ち越す。
- 状態エントリ処理: Ready で UI 初期化・入力マップ切替、Paused で AI/Spawn 停止かつ Render/UITick 継続、Victory/Defeat で Result 集計と BGM/SE を切替。再開系（Paused→Playing）は停止したシステムの再開と UI レイヤ復帰を行う。
- サウンド/入力連動: 状態ごとに BGM セット、SE キュー、入力バインドを切替。Paused ではホットキーを最小限に抑え、リトライ/戻るは Result へ遷移させる。
- 境界の固定: シーンは「リソース・UI・BGM・入力マップ切替＋SystemRunner再構成」のみ担当し、戦闘内の進行ロジックと遷移は `GameStateSystem` のみが扱う。シーンは終端通知を受け、次シーン要求を SceneManager に渡すだけに留める。

## 遷移フローとデータ受け渡し

- フロー: ホーム → ステージ選択 → ロード(Loading) → Ready → Playing ↔ Paused → Victory/Defeat → リザルト → 戻る/リトライ。
- データ: ステージ選択で `stageId` と編成/設定を確定し、ロード時に `StageLoader` + `MapValidator` + `ReferenceValidator` で検証。成功した定義のみ `DefinitionRegistry` と各システムに反映し、失敗時は旧データを保持して警告。
- リトライ/戻る: リトライは同ステージを再ロード（GameState を Loading→Ready へ）。戻るは SceneArgs.returnTo で明示指定（ホーム or ステージ選択など）。
- HotReload: エディタ保存→ローカル検証→ゲーム側再検証の順に実行し、成功時のみ `pendingTransition` を通じて状態/データ適用。失敗時はロールバックし、エディタとゲームの双方にエラーを通知。

## シーン遷移テーブル（確定版・Guard付き・明示戻り先）

| From                  | To                               | Trigger                   | Guard                               | ReturnTo（必須）                | 備考/禁止(×)                     |
|-----------------------|----------------------------------|---------------------------|-------------------------------------|---------------------------------|----------------------------------|
| タイトル               | ホーム / 設定                    | UI操作                    | なし                                | 呼び出し元明示                  | × その他                         |
| ホーム                 | ステージ選択 / 設定 / 図鑑       | UI操作                    | なし                                | 呼び出し元明示                  | × 戦闘/リザルト直行             |
| ステージ選択           | ステージ詳細パネル / 編成パネル / 設定 | UI操作（パネル開/設定）   | なし                                | 戻り先=ステージ選択固定         | × 戦闘直行（検証なし）          |
| ステージ詳細（パネル） | 編成パネル / クローズ            | UI操作                    | なし                                | 戻り先=ステージ選択固定         | 同一シーン内パネル              |
| 編成確認（パネル）     | 戦闘 / クローズ                  | UI操作                    | 編成検証OK AND ステージ検証OK       | 戻り先=ステージ選択固定         | ガードNG時はパネル内エラー表示  |
| 戦闘                   | リザルト                         | GameState終端通知         | Victory OR Defeat                   | リザルト固定                    | × 他シーン直行                  |
| リザルト               | ホーム / 戦闘再ロード            | UI操作（戻る/リトライ）   | なし                                | ホーム or 戦闘再ロード明示      | × 設定/図鑑直行                 |
| 設定                   | 呼び出し元へ戻る                 | UI操作（戻る）            | なし                                | 呼び出し元明示                  | × 他遷移                        |
| 図鑑                   | ホーム                           | UI操作（戻る）            | なし                                | ホーム固定                      | × 他遷移                        |

備考:

- 戻り先はすべて明示指定（スタックなし）。設定・図鑑も呼び出し元（ReturnTo）を必須指定する。
- ステージ詳細/編成は当面ステージ選択シーン内のパネルで完結。独立シーン化は後回し。
- 戦闘内の `Loading/Ready/Playing/Paused/Victory/Defeat` は `GameStateSystem` が管理し、シーン遷移には直接関与しない。

## SceneArgs / 戻り先ハンドリング

- SceneArgs: `stageId`, `difficulty`, `partySlot`, `returnTo`（戻り先シーンID）を明示引数で渡す。スタックは使わず、全遷移で戻り先を必須指定する。
- エラー時戻り先: ステージロード/検証失敗時はステージ選択へフォールバックし、エラーを表示。リトライ不可ならホームへ戻す。
- 戦闘終端: GameStateSystem が Victory/Defeat 終端理由を持ち、SceneManager へ終端通知（Resultデータとともに）を送るだけでシーン遷移を要求。

## 入力マップと優先度

- 優先度: エディタ > UI > ゲーム入力。Dev/Editorはアクティブ時のみ有効。
- ポーズ時: 戦闘入力を無効化し、UI入力のみ許可。再開で元のバインドに復帰。
- シーン切替: Enter/Exit で入力マップを差し替え、戦闘→リザルトでは戦闘系バインドを解除してリザルト専用に切替。

## 図鑑シーンの導線

- 配置: ホーム配下の独立シーンとし、戻り先はホーム固定（明示）。スタックは使用しない。
- 機能: 検索・タグ・ロールフィルタ必須（レアリティも可）、サムネ＋立ち絵表示。ホットリロードは図鑑メタ更新時のみ再読込をトリガ。
- リソース: アイコン/立ち絵はキャッシュするが欠落時はデフォルト画像を使用し、警告トーストを表示。

## ステージ詳細・編成確認の粒度

- 初期方針: ステージ選択シーン内の単一パネルでステージ詳細＋編成確認を完結。独立シーン化は後回し。
- 戦闘遷移条件: 編成検証OKかつステージ検証OKで戦闘へ遷移。いずれか失敗でステージ選択に留まりエラー表示。
- 戻り先: ステージ選択固定。ホームへ戻る導線はステージ選択経由。
- 条件不一致時: パネル内でトースト/ダイアログ表示し、再試行（再検証）/戻るの導線を提供する。
- 拡張余地: 将来分割する場合は遷移表/入力/BGM/UIレイアウトを再整理する必要がある。

## エラー・フォールバック

- 致命: 定義ファイル欠落/破損時はホームへ退避（メッセージ表示）、キャッシュ保持。非致命: バリデーション失敗はステージ選択に留めてエラー表示。
- ステージロード/検証失敗: ステージ選択へ戻し、必要に応じホームへ退避経路を用意。メッセージを表示し、キャッシュは保持。
- 図鑑/編成リソース欠落: デフォルト画像＋警告トースト。遷移自体は継続。
- HotReload失敗: 直前キャッシュを維持し、OnHotReload は呼ばない。
- ステージ詳細/編成パネル: 検証エラーはパネル内トースト/ダイアログで表示し、再試行導線（再検証/戻る）を出す。戻り先はステージ選択固定。

## テレメトリ/ログ

- SceneManager: `from→to`, `trigger`, `result/理由` を記録。GameStateSystem は終端理由（Victory/Defeat/Abort）を記録。
- HotReload: 適用/失敗ログを共通ロガーへ出力。戦闘中はステージ定義のみ許可し、失敗時は旧データを維持。
- 出力先: 既定はデバッグUI（ログパネル）へ表示し、必要に応じファイル/テレメトリ送信を追加。

## コンポーネント

- `GameStateComponent`
  - `state`（enum）
  - `timeScale`（0.0, 0.5, 1.0, 2.0）
  - `pendingTransition`（次状態）
- `StageDefinitionComponent`
  - `stageId`, `waves`, `lanes`, `cost`, `life`
  - `bossInfo`（waveId, name, announceTime）
  - `difficulty`（`baseHpMul`, `atkMul`, `rewardMul`）
- `LifeComponent`（拠点）
  - `life`, `maxLife`
- `ResultComponent`
  - `clearTime`, `remainingLife`, `score`, `rewards`

## システム

### GameStateSystem

- 入力: `GameStateComponent`, ユーザー入力（ポーズ/速度変更）
- 処理:
  - `state` に応じて Update を分岐。
  - `Paused` ではロジック更新をスキップ（UIは許可）。
  - `timeScale` を全システムに伝播（Physics/Animation/Particle/Combat の deltaTime に乗算）。
- 遷移条件:
  - Victory: `WaveScheduler` 完了 + 敵全滅。
  - Defeat: `LifeComponent.life <= 0` または 制限時間切れ（任意）。

### StageLoaderSystem

- ステージ JSON をロードして `StageDefinitionComponent` をセット。
- `lanes`/`waves`/`cost` をそれぞれのレジストリへ転送。
- `life` 初期化、UI に初期値を通知。

### StageReadySystem

- カウントダウン（3..2..1..Start）演出。
- `GameState` を `Playing` に変更。

### LifeSystem

- 敵到達時に `life` を減算。0 以下で `Defeat`。
- UI へ `LifeChanged` イベント送信。

### ResultSystem

- Victory/Defeat 遷移時に統計を集計（クリア時間、残ライフ、使用コスト量など）。
- リザルト UI へデータを送る。

## ステージJSON（例）

```json
{
  "id": "stage_01",
  "displayName": "草原の侵攻",
  "life": 20,
  "difficulty": { "atkMul": 1.0, "hpMul": 1.0, "rewardMul": 1.0 },
  "lanes": [...],
  "cost": { "max": 50, "start": 10, "regenPerSec": 2.5 },
  "waves": [...],
  "boss": { "waveId": 2, "announceTime": 3.0, "name": "スライムロード" }
}
```

- 難易度バリエーション: `stage_01_easy/normal/hard` などで倍率のみ変更。

## UI連携

- `StateChanged(state)`
- `TimeScaleChanged(scale)`
- `LifeChanged(current, max)`
- `BossIncoming(waveId, name)`
- `ResultReady(victory, stats)`
- ポーズメニュー: 再開/リトライ/ステージ選択へ。

## コアループ詳細と勝敗・報酬

- 進行フロー: タイトル → ステージ選択 → ロード → Ready演出 → Playing（0.5x/1x/2x）↔ ポーズ → Victory/Defeat → リザルト → リトライ/戻る。
- 勝利条件: 全ウェーブ消化＋敵殲滅。敗北条件: ライフ0 または タイマー敗北（ステージ定義で有効化）。
- リトライ: 現行ステージを即時再ロード。報酬はVictory時のみ適用、Defeat時は再挑戦導線のみ。
- 報酬フロー: Victory → ResultSystem で統計集計 → 報酬テーブル適用（ゴールド/経験値/アイテム）→ セーブ反映。

## 経済・バランス指標（目安）

| 指標 | 目安 |
| --- | --- |
| コスト開始値/最大値 | 10 / 50 |
| コスト回復 | 2.5/秒（初期）、難度で±20% |
| 敵HP帯 | 序盤 50-150, 中盤 200-600, 終盤 800-1500 |
| 敵DPS帯 | 序盤 5-15, 中盤 20-60, 終盤 80-150 |
| ウェーブ難度カーブ | WaveごとにHP/攻撃を1.12〜1.18倍、ボスは+40〜60% |
| 期待クリア時間 | 1面 2-3分, 2面 3-4分, 3面 4-6分 |

## ユニット/敵ロール定義

- 前衛: 高耐久/短射程、足止めと受け。  
- 後衛: 中〜長射程/中DPS、耐久低。  
- サポート: バフ/デバフ/回復、CC提供。  
- 範囲/CC: スロー/スタン/ノックバックで群れ対応。  
- ボス: 高HP/高DPS/特殊ギミック、耐CCやフェーズ持ち。

## コンテンツ例（概要）

- ユニット/敵/アビリティのメタ:  
  - ユニット: 前衛「ガードA」(高耐久, 近接), 後衛「レンジャーB」(中射程, 単体DPS), サポート「ヒーラーC」(回復, 低耐久)。  
  - 敵: 雑魚「スライム」(低HP低DPS), エリート「ゴブリン」(中HP中DPS), ボス「スライムロード」(高HP, 範囲攻撃)。  
  - アビリティ: 範囲火球(DoT), 単体高火力, 回復バースト。
- 代表ステージ例（期待クリア時間は上表参照）:

| ステージ | 推奨HP倍率/攻撃倍率 | Wave数 | ボス | 備考 |
| --- | --- | --- | --- | --- |
| 1面 | 1.0 / 1.0 | 3 | 無 | 入門、チュートリアル |
| 2面 | 1.15 / 1.1 | 4 | Wave4 | 雑魚ラッシュ後に中ボス |
| 3面 | 1.25 / 1.2 | 5 | Wave5 | 耐久＋範囲DPS要求 |

## UX/フロー（ポーズ/速度/チュートリアル/遷移）

- ポーズ: Esc/Start で即時停止、UIのみ有効。  
- 速度変更: 0.5x/1x/2x をUIトグルとホットキーで提供。  
- チュートリアル導線: 1面開始時に操作オーバーレイ、ポーズ中にヘルプパネル表示。  
- 画面遷移: タイトル → ステージ選択 → ゲーム（Ready→Playing→Victory/Defeat）→ リザルト → リトライ/戻る。

## 入力/操作ポリシー（抜粋）

- アクセシビリティ: 色覚配色プリセット、フォントサイズスライダ、マスター/SE/BGM音量スライダ。  
- 入力割り当て: マウス（左クリック配置/選択、右クリックキャンセル）、ホイールズーム/パン（仮想座標で補正）、キーボードショートカット（速度変更/ポーズ/リトライ）。  
- 仮想座標対応: 1920x1080基準で入力を正規化し、UI/選択ヒットを補正。

## 演出・フィードバック / テレメトリ

- 通知: ボス出現、ウェーブ開始/終了をUIトースト＋サウンドで告知。  
- フィードバック: ヒット/被弾/死亡/クリア失敗時にエフェクト＋SE＋UIトースト（色コード: ダメージ=赤、被弾=オレンジ、死亡=紫、敗北=灰）。  
- テレメトリイベント: `boss_spawned`, `wave_started`, `wave_finished`, `player_hit`, `player_down`, `defeat`, `victory` を発火（DevModeコンソールとログに送る）。

## データフロー/保存

- セーブデータ: 進行度（ステージクリア履歴、難度、報酬獲得）、設定（入力/音量/色覚/フォントサイズ/速度プリセット）。  
- 保存タイミング: Victory時と設定変更時に即時保存。ポーズ中の明示的保存は省略。  
- スキーマ更新時: `schemaVersion` を設けず最新版前提。破壊的変更はローダで検知し、互換変換がない場合はセーフモードで読み取り専用＋再保存を要求（既存セーブを保護）。

## セーブ/ロード方針（簡潔）

- スロット3固定、プリセット構造は `main[3]/sub[5]/abilities[2]`。欠落は空で補完。  
- バックアップはローテーション保持（最新+数世代）。破損時は最新バックアップへロールバックし警告。  
- ロード時は未知キー無視・欠落補完。致命エラーは読み取り専用で扱い、再保存を促す。

## ステージ詳細・リザルト（軽量必須版）

- ステージ詳細: 推奨戦力、敵プレビュー、報酬、難易度解放条件（Easy/Normal/Hard）のみ表示。  
- リザルト導線: Victory/Defeat後に結果表示 → リトライ/ホームへ戻る。追加のミッション詳細や拡張メニューは省略。

## DevMode / テスト

- ステージスキップ: 次ウェーブへジャンプ。
- 即時クリア/失敗トグル（演出確認用）。
- タイムスケール直接入力。
- JSONホットリロード: `StageLoaderSystem` が再ロードし、`WaveScheduler`/`LaneManager`/`CostSystem` に再配信。

## 実装ステップ（チェックリスト）

- [ ] `GameStateComponent` と `GameStateSystem` を追加し、ポーズ/速度変更を管理
- [ ] `StageLoaderSystem` でステージJSONをロードし、`WaveScheduler/LaneManager/Cost` に配信
- [ ] `LifeSystem` で拠点ライフを管理し、到達ダメージと Defeat 判定を行う
- [ ] Victory 判定（全ウェーブ完了＋敵殲滅）と Result 集計を実装
- [ ] UIイベント: 状態・ライフ・ボス予告・結果を通知
- [ ] DevMode: ステージリロード/スキップ/速度変更のデバッグ操作を追加
